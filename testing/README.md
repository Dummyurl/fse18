# Testing of Energy Inefficiencies

This folder contains the tools used to confirm potential energy
inefficiencies reported by the static analysis using run-time
information.

## Structure

- `crop` contains the cropped screenshots generated by running
`check_ambient_screenshots.py`;
- `monkey` is the library for interactaction with the devices;
- `screenshots` includes the screenshots of watch faces reported
by the static analysis that contain potential display-related
energy inefficiencies taken by running `test_display.py`;
- `unicodecsv` contains utility classes for reading and saving
intermediate data, i.e., watch face names;
- `check_ambient_screenshots.py` checks the screenshots for display-
related energy inefficiencies according to the two criteria introduced
in the paper, i.e., 90% black pixels and GEMMA;
- `display.leak.txt` contains the APK names that have potential
display-related energy inefficiencies;
- `connect_wear.sh` is used to connect to Wear device by bluetooth;
- `parse_label.py` parses APKs to fetch the titles for watch faces;
- `pkg_wfs_label.csv` is pre-generated by running `parse_label.py`;
- `README.md`: this file;
- `sensor.leak.txt` contains the APKs that have potential sensor-
related energy inefficiencies with the results by running tests;
- `supported.sensors.txt` is the programmatically dumped list of
supported sensors on LG Watch Style;
- `test_display.py` installs APKs and take screenshots of
watch faces in *ambient* mode;
- `test_sensor.py` is the test skeleton of test cases runnable for
verification of sensor-related energy inefficiencies.

## Install

This work requires a Android Wear device, as well as a companion
handheld device. The handheld device is used for automatic selection
and deselection of watch faces. Android SDK and Python 2.7.15 are
required. The following libraries are also required.

```bash
$ pip install beautifulsoup4 Pillow colorama uiautomator
```

## Run

### Prerequisite

Run `./parse_label.py` to fetch all watch faces and their titles
from downloaded APKs. They are used for automatic installation and
selection of watch faces. A pre-generated file is located at
`pkg_wfs_label.csv`. The first column shows the package name.
The second and third columns are watch face class name and the
corresponding title displayed in the Android Wear app on the handheld
device. When installed on the watch, a watch face is synced to the
Wear app. The testing tool utilizes this to select the watch face
according to its title on the handheld, intead of directly manipulates
the watch face picker on the smartwatch.

By running the static analysis (located at `../analysis`), we
can get a list of watch faces that have potential energy
inefficiencies. For the 1490 watch faces in paper, they are stored
in `display.leak.txt` and `sensor.leak.txt`.

Before running actual tests, intall and open Google's Android Wear app
(now as Wear OS app) on a handheld device and connect it to the machine
with debug mode turned on. Pair a smartwatch with it and enable
the 'Debug via Bluetooth' on the watch. Replace the `HANDHELD_SERIALNO`
field in `test_display.py` and `test_sensor.py` with the actual
serial number of the handheld device. Add `monkeyrunner` in Android
SDK to `PATH`.


### Display-Related

Run `test_display.py` to verify the reported watch faces for display-
related inefficiencies in `display.leak.txt`.
It reads the watch face list from the the file. For each watch
face, the script first installs the Wear APK and handheld APK on the
smartwatch and the handheld devices accordingly. It then select the
watch face in the Android Wear app on the handheld by title. After
the selection taking effect, it waits for 30 seconds to make sure the
watch face goes into *ambient* mode and takes a screenshot of the
smartwatch saving to `screenshots`.

Run `check_ambient_screenshots.py` to do the assessment of energy
consumption of the screenshots. It first crops the screenshots into
round shape (stored in `crop`) as they are taken as square pictures
while LG Watch Style has a round screen. Then it generates an estimate
of energy consumpution by calculating the ratio of black pixels and the
color in the screenshot, as described in the experiments in the paper.
The output is colored: *green* means the watch face is considered OK
and not reported to the developer; *red* means the report is confirmed
and we determine that the watch face indeed contains an inefficiency.
One thing to **notice** is that the numbers in the output are different
from the numbers in the paper. This is because some of the watch faces
have paid features and it is indeed those features causing the inefficiency.
We bought one watch face for each group. By group we mean a set of watch
faces that share same functionalities and features, as we find many of the
paid watch faces are only variants with slight changes such as background
color of each other. We decided not to buy more and considered watch
faces in a group as a whole. The numbers in the paper reflect that.

### Sensor-Related

For each watch face that is reported containing potential sensor-
related energy inefficiencies, in its log there are test case code
generated. Copy the code and place it after the comment 'MAIN TEST BODY'
in `test_sensor.py`. Then replace the package name in the invocation
of `install_test`. Finally run `test_sensor.py` and check the log for
any indication of sensor leaks. **Note** that not all sensors are
supported by LG Watch Style. We have fetched a list of supported sensors
in `supported.sensors.txt`. We exclude in the paper those acquiring sensors
beyond this list. The details of the results of the experiment are in
`sensor.leak.txt`.

